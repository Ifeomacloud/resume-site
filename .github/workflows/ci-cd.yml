name: Build & Deploy

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.build_image.outputs.tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - id: build_image
        run: |
          # Build your Docker image
          IMAGE_TAG="docker.io/ifeoma028/resume-site:v1.0"
          echo "Building Docker image: $IMAGE_TAG"
          docker build -t "$IMAGE_TAG" .

          # Push to registry (optional, uncomment if needed)
          # docker push "$IMAGE_TAG"

          # Export image tag as output for next job
          echo "tag=$IMAGE_TAG" >> $GITHUB_OUTPUT

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          script: |
            #!/bin/bash
            set -euo pipefail

            # Get image from previous job
            IMAGE="${{ needs.build.outputs.image-tag }}"
            DEPLOY_PATH="/home/ubuntu/deploy/start.sh"

            # Debug log
            echo "DEBUG: Deploying image: [$IMAGE]"

            # Fail if IMAGE is empty
            if [ -z "$IMAGE" ]; then
              echo "ERROR: IMAGE is empty. Aborting."
              exit 2
            fi

            # Run deployment script
            echo "Running deployment script: $DEPLOY_PATH"
            bash "$DEPLOY_PATH" "$IMAGE"

            # Healthcheck loop
            HEALTH_URL="http://127.0.0.1:80/"
            MAX_TRIES=12
            TRY=1
            until curl -fsS "$HEALTH_URL" >/dev/null 2>&1; do
              if [ "$TRY" -ge "$MAX_TRIES" ]; then
                echo "Healthcheck failed after $TRY attempts."
                docker logs --tail 200 resume-site || true
                exit 10
              fi
              echo "Healthcheck attempt $TRY/$MAX_TRIES failed, retrying in 5s..."
              TRY=$((TRY+1))
              sleep 5
            done

            echo "Healthcheck succeeded. Deployment complete."
